# 执行上下文
- 什么是执行上下文

  执行JavaScript代码环境的抽象概念。每当JavaScript代码执行时，都是在执行上下文中运行。

- 执行上下文类型

  |  类型   |   |
  |  ----  | ---- |
  | 全局执行上下文 | 任何不在函数内部的代码都在全局上下文中。 <br>创建一个全局的window对象（浏览器），并设置this的值等于这个全局对象。<br>一个程序中只有一个全局执行上下文。 |
  | 函数执行上下文 |  每当一个函数<kbd>**被调用**</kbd>的时候，都会为该函数创建一个新的执行上下文。<br>每个函数都有他自己的执行上下文。<br>每当一个新的执行上下文被创建，它会按定义的顺序执行一系列步骤。 |
  | Eval执行上下文 | 执行在 eval 函数内部的代码也会有它属于自己的执行上下文。 |
     
- 执行栈

  一种拥有“后进先出”的数据结构的栈，用来存储所有代码执行时产生的执行上下文。
  
  当JavaScript引擎第一次执行脚本，先会创建一个全局执行上下文压入当前执行栈。每当遇到一个函数调用，它会创建一个函数执行上下文并压入栈的顶部。
  
  JavaScript引擎会优先执行执行上下文位于栈顶的函数。当函数执行结束，执行上下文从栈中弹出，控制流程到当前栈中的下一个执行上下文。
  
   ```
    ExectionContextStack = [];
    ExectionContextStack.push(GlobalExecutionContext); // 首次执行JavaScript脚本, 创建全局执行上下文并压入当前执行栈
    ExectionContextStack.push(<Func>ExecutionContext); // 每次遇到函数调用，都会创建一个函数执行上下文并压入当前栈
    ExectionContextStack.pop(); // 执行栈会优先执行位于栈顶的函数，执行结束同时删除当前函数执行上下文
  ```
  
- 如何创建执行上下文

  创建执行上下文有两个阶段：1) **创建阶段** 和 2) **执行阶段**。
  
  ### 创建阶段
  
  | 创建阶段发生的事情 |
  | ------- |
  | 1.**this**值的绑定<br>2.创建**词法环境**组件<br>3.创建**变量环境**组件 |
  
    
  代码形式：
  
  ```javascript
    ExectionContext = {
      thisBinding = <this>,  // this绑定
      LexicalEnvironment = { ... }, // 词法环境
      VariableEnvironment = { ... } // 变量环境
    }
  ```
  
  \[**This 绑定**\]
  
  在全局执行上下文中，``this``值指向全局对象。
  
  在函数执行上下文中，``this``值取决于函数如何被调用。
    - 如果被一个引用对象调用，则``this``会被设置成这个对象
    - 否则``this``值会被设置成全局对象或者undefined
  
  \[**词法环境**\]
  
   > 词法环境是一种规范类型，基于 ECMAScript 代码的词法嵌套结构来定义标识符和具体变量和函数的关联。    
   > 一个词法环境由环境记录器和一个可能的引用外部词法环境的空值组成。



  词法环境内部有2个组件：    
    - 环境记录器： 存储变量和函数声明的实际位置。    
    - 外部环境的引用： 可以访问父级词法环境(作用域)。
  
  词法环境类型：
    - 全局环境    
      在全局执行上下文中，是没有外部环境引用的词法环境。    
      全局环境的外部环境引用是 null。它拥有内建的 Object/Array等、在环境记录器内的原型函数（关联全局对象，比如 window 对象）还有任何用户定义的全局变量，并且 this的值指向全局对象。
     
    - 函数环境    
      函数内部用户定义的变量存储在环境记录器中。    
      并且引用的外部环境可能是全局环境，或者任何包含此内部函数的外部函数。
      
  全局执行上下文代码形式：
  
  ```javascript
      GlobalExectionContext = {
        LexicalEnvironment: {
          // 对象环境记录器
          EnvironmentRecord: {
            Type: "Object",
          },
          outer: <null> // 外部环境引用
        }
      }
  ```
  
  
  
  函数执行上下文代码形式：    
  注：在函数环境中，声明式环境记录器还包含了一个传递给函数的 ``arguments`` 对象（此对象存储索引和参数的映射）和传递给函数的参数的 ``length``。
  
  ```javascript
      FunctionExectionContext = {
        LexicalEnvironment: {
          // 声明式环境记录器
          EnvironmentRecord: {
            Type: "Declarative",
            Arguments：{ length: Number } 
          },
          outer: <Global or outer function environment reference> // 外部环境引用
        }
      }
  ```

  \[**变量环境**\]
  
  - 它同样是一个词法环境，其环境记录器持有变量声明语句在执行上下文中创建的绑定关系。
  - 变量对象是与执行上下文相关的数据作用域，存储了在上下文中定义的变量和函数声明。
  - 词法环境组件和变量环境的一个不同就是前者被用来存储函数声明和变量（``let`` 和 ``const``）绑定，而后者只用来存储 ``var`` 变量绑定。
  
  ### 执行阶段
  
  在此阶段，完成对所有变量的分配，最后执行代码。
  
  注：如果执行阶段，不能在源码中找到let变量的值，它会被赋值undefined。
